<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ReaalArvaja üïµÔ∏è</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>

      /* Hide Matterport navigation pucks (sweep points) */
  .mp-sweep-point,            /* the little white puck elements */ 
  .mp-sweep-point-circle {    /* alternate class name in some versions */
    display: none !important;
  }

    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      font-family: 'Courier New', monospace;
      
      background: #1a1a1a;
      color: #00ffff;
    }
    /* HUD at the top */
    #hud {
      display: flex;
      justify-content: space-between;
      width: 100%;
      padding: 10px 20px;
      box-sizing: border-box;
      background: rgba(0,0,0,0.8);
      z-index: 2;
      position: absolute;
      top: 0;
    }
    .hud-item {
      background: #333;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
    /* Main container fills the viewport minus the HUD */
    .game-container {
      position: absolute;
      top: 60px; /* height of the HUD */
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      gap: 10px;
    }
    /* Left side: Virtual tour (Matterport) takes ~75% of the width */
    #photo-container {
      flex: 3;
      position: relative;
    }
    /* The Matterport iframe fills its container */
    #matterport-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,255,255,0.3);
    }
    /* Right side: the guessing map occupies about 25% */
    #map-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.8);
      border-radius: 10px;
    }
    /* The Leaflet map */
    #map {
      width: 100%;
      height: 300px;
      border: 3px solid #00ffff;
      border-radius: 10px;
    }
    button {
      background: #00ffff;
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px #00ffff;
    }
    #result {
      font-size: 1.1em;
      text-align: center;
      margin-top: 10px;
    }
    #matterport-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    #matterport-iframe {
      width: 100%;
      height: 100%;
    }

    .matterport-banner {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 15%; /* Covers the lower 25% of the iframe */
      background: rgba(0, 0, 0, 1); /* Semi-transparent black */
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 10; /* Ensure it overlays the iframe */
    }
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    <div class="hud-item">üïí Aeg: <span id="timer">60</span>s</div>
    <div class="hud-item">üèÜ Score: <span id="score">0</span></div>
    <div class="hud-item">üîÑ Round: <span id="round">1</span>/5</div>
  </div>
  
  <div class="game-container">
    <!-- Left: Matterport Virtual Tour -->
    <div id="photo-container">
      <div id="matterport-container">
        <iframe id="matterport-iframe" src="" frameborder="0"></iframe>
        <div class="matterport-banner">
          <h1>ReaalArvaja üïµÔ∏è</h1>
          <p>Arva, kus oled!</p>
        </div>
      </div>
    </div>
    
    <!-- Right: School Plan Map for Guessing -->
    <div id="map-container">
      <div id="map"></div>
      <button id="submitGuess" disabled>üöÄ Launch Guess</button>
      <div id="result"></div>
    </div>
  </div>
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // -------------- Game State and Settings --------------
    let score = 0;
    let currentRound = 1;
    let gameActive = true;
    let timerInterval;
    let currentLocationIndex = 0;
    const totalRounds = 5;
    const locationsPerRound = 5;
  
    // Locations for the guess game on the school plan.
    // Coordinates here are in pixel values relative to your school_plan.jpg.
    const locations = [
      {name: "Anu Kell", coord: [1200, 800]},
      {name: "Villu Raja", coord: [500, 600]},
      {name: "Martin Saar", coord: [900, 200]}
    ];
  
    // Dimensions for the school_plan.jpg
    const imgWidth = 2000, imgHeight = 1500;
  
    // Matterport base embed info: we use the same tour, but randomize starting parameters.
    const matterportBase = "https://my.matterport.com/show/";
    const matterportTourID = "JP9YgC9agCW";
    // Define several parameter sets for random starting scenes/rotations.
    const matterportParams = [
      { ss: "9", sr: "-2.58,-1.08" },
      { ss: "142", sr: "-0.21,-0.45" },
      { ss: "5", sr: "1.23,0.45" },
      { ss: "7", sr: "2.34,-0.56" },
      { ss: "364", sr: "-0.22,-0.68" },
      { ss: "362", sr: "-2.96,-0.09" },
      { ss: "343", sr: "-2.81,-0.01" },
      { ss: "18", sr: "-0.92,-0.67" },
      { ss: "93", sr: "-0.37,-0.03" },
      { ss: "162", sr: "-2.28,0.24" }
    ];
  
    // -------------- Setup the Leaflet Map --------------
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: true
    });
    const southWest = map.unproject([0, imgHeight], map.getMaxZoom());
    const northEast = map.unproject([imgWidth, 0], map.getMaxZoom());
    const bounds = new L.LatLngBounds(southWest, northEast);
    L.imageOverlay('/static/images/school_plan.jpg', bounds).addTo(map);
    map.fitBounds(bounds);
  
    // -------------- Game Logic Variables --------------
    let currentLocation = null;
    let guessMarker = null;
    let trueMarker = null;
  
    // -------------- Initialize the Game --------------
    function initializeGame() {
      score = 0;
      currentRound = 1;
      gameActive = true;
      document.getElementById('score').textContent = '0';
      document.getElementById('round').textContent = '1';
      document.getElementById('timer').textContent = '60';
      newRound();
      startTimer();
    }
  
    // -------------- New Round Setup --------------
    function newRound() {
      if (!gameActive) return;

      // Check if the game has ended
      if (currentRound > totalRounds) {
        endGame();
        return;
      }

      // Start the timer for the new round
      startTimer();

      // Pick a new location for the round
      currentLocation = locations[currentLocationIndex];
      resetMap();
      updateMatterportEmbed();

      // Update round display
      document.getElementById('round').textContent = currentRound;
    }
  
    function resetMap() {
      if (guessMarker) map.removeLayer(guessMarker);
      if (trueMarker) map.removeLayer(trueMarker);
      // Project the true position (using a fixed zoom 0 for consistency)
      const trueLatLng = map.unproject(currentLocation.coord, 0);
      trueMarker = L.marker(trueLatLng, {
        opacity: 0, // hidden during gameplay
        icon: L.divIcon({className: 'true-marker', html: 'üéØ'})
      }).addTo(map);
    }
  
    // -------------- Update Matterport Embed --------------
    function updateMatterportEmbed() {
      // Randomly select a parameter set.
      const randomParams = matterportParams[Math.floor(Math.random() * matterportParams.length)];
      // Build the embed URL with parameters to autoplay and (hopefully) hide UI.
      const embedUrl = `${matterportBase}?play=1&lang=en-US&m=${matterportTourID}&ss=${randomParams.ss}&sr=${randomParams.sr}&brand=0&ui_controls=0&help=0&hr=0&ts=-1&dh=0&vr=0&brand=0&mls=2&f=0&fp=0&gt=0`;
      // Set the Matterport iframe src.
      document.getElementById("matterport-iframe").src = embedUrl;
    }
  
    // -------------- Distance Calculation --------------
    // Project both the guessed and true positions using zoom level 0.
    function calculatePixelDistance(guessLatLng) {
      const truePoint = map.project(trueMarker.getLatLng(), 0);
      const guessPoint = map.project(guessLatLng, 0);
      return Math.sqrt(Math.pow(truePoint.x - guessPoint.x, 2) + Math.pow(truePoint.y - guessPoint.y, 2));
    }
  
    // -------------- Timer Functions --------------
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 30; // Reset timer to 30 seconds
      document.getElementById('timer').textContent = timeLeft;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          endLocation();
        }
      }, 1000);
    }

    function endLocation() {
      clearInterval(timerInterval);
      document.getElementById("result").innerHTML = "‚è∞ Time's up! Moving to the next location...";
      setTimeout(() => {
        currentLocationIndex++;
        if (currentLocationIndex >= locationsPerRound) {
          currentLocationIndex = 0;
          currentRound++;
          if (currentRound >= totalRounds) {
            endGame();
            return;
          }
        }
        newLocation();
      }, 2000);
    }

    function newLocation() {
      setTimeout(() => {
        updateMatterportEmbed(); // Update Matterport iframe
        startTimer(); // Start the timer
      }, 1000);

      // Reset the true marker and guess marker
      if (trueMarker) map.removeLayer(trueMarker);
      if (guessMarker) map.removeLayer(guessMarker);

      // Generate a new true location
      const trueLatLng = map.unproject(currentLocation.coord, 0);
      trueMarker = L.marker(trueLatLng, {
        opacity: 0, // Hidden until the guess is made
        icon: L.divIcon({ className: 'true-marker', html: 'üéØ' })
      }).addTo(map);

      // Clear the result message
        document.getElementById("result").innerHTML = "";
      }
  

    function updateMatterportEmbed() {
      // Randomly select a parameter set for the Matterport tour
      const randomParams = matterportParams[Math.floor(Math.random() * matterportParams.length)];
      const embedUrl = `${matterportBase}?play=1&lang=en-US&m=${matterportTourID}&ss=${randomParams.ss}&sr=${randomParams.sr}&brand=0&ui_controls=0&help=0&hr=0&ts=-1&dh=0&vr=0&brand=0&mls=2`;
      document.getElementById("matterport-iframe").src = embedUrl;
    }

    function endGame() {
      gameActive = false;
      clearInterval(timerInterval);
      setTimeout(() => {
        window.location.href = '/';
      }, 3000);
      document.getElementById("result").innerHTML =
        `M√§ng L√§bi! Redirecting home...<br>L√µplik Skoor: ${score}`;
    }
  
    // -------------- Event Listeners --------------
    map.on('click', e => {
      if (!gameActive) return;
      if (guessMarker) map.removeLayer(guessMarker);
      guessMarker = L.marker(e.latlng, {
        icon: L.divIcon({className: 'guess-marker', html: 'üìç'})
      }).addTo(map);
      document.getElementById("submitGuess").disabled = false;
    });
    
    document.getElementById("submitGuess").addEventListener("click", () => {
      if (!gameActive || !guessMarker) return;
      const distance = calculatePixelDistance(guessMarker.getLatLng());
      const points = Math.max(1000 - Math.floor(distance), 0);
      score += points;
      document.getElementById('score').textContent = score;

      // Show the true marker
      trueMarker.setOpacity(1);

      // Draw a line between the guess and the true location
      const line = L.polyline([guessMarker.getLatLng(), trueMarker.getLatLng()], {
        color: 'cyan',
        weight: 2,
        dashArray: '5, 5'
      }).addTo(map);

      document.getElementById("result").innerHTML = `
        ${distance < 50 ? "üéâ Bullseye!" : 
         distance < 150 ? "üî• Getting warm!" : 
         distance < 300 ? "üôÇ Close enough" : "‚ùÑÔ∏è Cold..."}<br>
        +${points} points! (${Math.round(distance)}px away)
      `;

      currentRound++;
      document.getElementById('round').textContent = currentRound;
      document.getElementById("submitGuess").disabled = true;

      // Move to the next round after 2 seconds
      setTimeout(() => {
        map.removeLayer(line); // Remove the line before starting the next round
        newRound();
      }, 2000);
    });
  
    // -------------- Start the Game --------------
    initializeGame();
  </script>
</body>
</html>